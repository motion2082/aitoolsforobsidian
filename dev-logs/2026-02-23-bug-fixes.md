# Dev Log — 2026-02-23 — Settings cleanup, auto-install removal, Linux fixes, Gemini empty-response handling

## Branch: `fix/acp-cleanup-and-resource-leaks`

---

### 1. Settings: Install hints below agent Path fields

Added static install command text to each agent's Path setting description so users always see how to install, instead of only seeing it in a transient toast when Auto-detect fails.

**Files changed:**
- `src/components/settings/AgentClientSettingTab.ts`

**Details:**
- Claude Code: "Install via: npm install -g @zed-industries/claude-code-acp"
- Codex: "Install via: npm install -g @zed-industries/codex-acp"
- Gemini CLI: "Install via: npm install -g @google/gemini-cli"

---

### 2. Settings: Agent dropdown cleanup

Cleaned up the active agent dropdown in settings.

**Files changed:**
- `src/components/settings/AgentClientSettingTab.ts`

**Details:**
- Removed Codex from the agent dropdown (not yet available)
- Added "- Recommended" label to Claude Code option
- Added "In development" description to the Codex settings section heading

---

### 3. Removed `autoInstallAgents` setting and silent auto-install

The `autoInstallAgents` toggle promised to automatically install missing agents but was buggy: it didn't persist the detected path to the settings store, re-ran `npm install -g` on every Obsidian restart when the path field was blank, and conflicted with the separate "Install" button error path in the chat view.

The onboarding wizard already handles first-time installation. The explicit "Install" button in chat errors is the better UX for post-onboarding installs.

**Files changed:**
- `src/plugin.ts` — Removed `autoInstallAgents` from settings interface, defaults, and validation
- `src/hooks/useAgentSession.ts` — Deleted ~150 lines: `autoInstallAgent()` function, `getCommandNameForAgent()`, `InstallResult` interface, and the silent auto-install block in `createSession()`
- `src/adapters/acp/acp.adapter.ts` — Removed `autoInstallAgents` checks; Install button now always shows for known agents
- `src/components/settings/AgentClientSettingTab.ts` — Removed the toggle from settings UI
- `src/components/OnboardingModal.ts` — Removed `settings.autoInstallAgents = true` assignment

**What was kept:**
- "Install" button in chat error state (user-initiated, explicit)
- `canAutoInstall` field on `AgentError`
- `installCurrentAgent()` in AcpAdapter
- All helpers in `shared/agent-installer.ts`

---

### 4. Fixed: Install button not clearing error after successful install

After clicking "Install" in the chat error view, the agent installed successfully (path saved to `plugin.settings`) but the error persisted. Root cause: `setAgentCommand()` in AcpAdapter called `plugin.saveSettings()` which only persists to disk — it did not update the in-memory settings store. When `createSession()` immediately called `settingsAccess.getSnapshot()`, it got stale data with an empty command.

**Files changed:**
- `src/adapters/acp/acp.adapter.ts`

**Fix:**
- Changed `setAgentCommand()` to use `plugin.saveSettingsAndNotify()` instead of `plugin.saveSettings()`, which both persists and syncs the settings store snapshot.

---

### 5. Linux: npm global permissions error handling in onboarding

On Linux distros where Node.js is installed via system package manager (apt, pacman, etc.), `npm install -g` fails with EACCES/permission denied because it tries to write to `/usr/lib/node_modules/`. The onboarding previously showed an unhelpful "try running as administrator" message.

**Files changed:**
- `src/components/OnboardingModal.ts`
- `src/shared/path-detector.ts`

**Details:**
- Improved EACCES error detection to show step-by-step fix instructions
- Both error display paths (re-render and inline) now show the `~/.npm-global` setup commands:
  ```
  mkdir -p ~/.npm-global
  npm config set prefix '~/.npm-global'
  echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
  source ~/.bashrc
  ```
- Users can then click "Retry Installation" after running the commands
- Added shell variant note for zsh/fish users
- Added `~/.npm-global/bin/` paths to `COMMON_AGENT_PATHS` in `path-detector.ts` so auto-detect finds agents installed with the custom npm prefix
- Tested scenario: CachyOS with system Node.js, confirmed this is the standard fix for any Linux distro with package-manager-installed Node

---

### 6. Fixed: "Authentication Required" error masking empty response from Gemini CLI

On CachyOS Linux, Gemini CLI returned `code: 500, message: "Model stream ended with empty response text."` — a transient model failure. The error handler misidentified this as an authentication error because `isEmptyResponseError()` only matched the Claude Code variant (`code: -32603`, `data.details`), and the fallback path treated all unrecognized errors as auth failures.

**Files changed:**
- `src/shared/message-service.ts`

**Fix:**
- Broadened `isEmptyResponseError()` to match both variants:
  - Claude Code: `code: -32603` + `data.details` contains "empty response text"
  - Gemini CLI: `code: 500` + `message` contains "empty response text"
- Added auto-retry: on empty response, the prompt is retried once silently
- If retry also fails, shows "Empty Response — please try again" instead of misleading "Authentication Required"
- Added `console.warn("[AgentClient] Empty response from agent, retrying...")` so retries are always visible in DevTools regardless of Debug Mode setting

---

### 7. Gemini CLI marked as experimental; Claude Code marked as recommended

Gemini CLI's ACP mode (`--experimental-acp`) has limited tool support — complex prompts requiring file system access return empty responses (code 500). Basic chat works, but it's not on par with Claude Code's full tool support.

**Files changed:**
- `src/components/OnboardingModal.ts` — Claude Code description: "Recommended — full tool support"; Gemini CLI description: "Experimental — limited tool support"
- `src/components/settings/AgentClientSettingTab.ts` — Gemini CLI dropdown label: "- Experimental"; Gemini CLI settings section desc: "Experimental — limited tool support through ACP mode."

---

### 8. Fixed: onSessionUpdate callback re-registration causing vanishing responses

The `onSessionUpdate` callback in `ChatView.tsx` was being re-registered mid-stream whenever its `useEffect` dependencies changed (`session.sessionId`, `isLoadingSessionHistory`, etc.). Since `acpAdapter.onSessionUpdate()` is a simple setter, updates arriving during re-registration could be lost, causing agent response text to appear then vanish.

**Files changed:**
- `src/components/chat/ChatView.tsx`

**Fix:**
- Switched to a ref-based approach: store changing values in refs (synced every render) and register the callback once per adapter instance
- The callback reads current values from refs at invocation time, avoiding re-registration

---

### 9. Migrate from `@zed-industries/claude-code-acp` to `@zed-industries/claude-agent-acp`

The npm package `@zed-industries/claude-code-acp` was deprecated at v0.16.2 and renamed to `@zed-industries/claude-agent-acp` (v0.18.0+). The binary also changed from `claude-code-acp` to `claude-agent-acp`.

Tested on CachyOS Linux: onboarding installed the deprecated package but session creation failed because `saveSettings()` was fire-and-forget — the path wasn't persisted before the chat view tried to create a session. Worked after restarting Obsidian (settings already on disk).

**Files changed:**
- `src/shared/agent-installer.ts` — Updated npm package name to `@zed-industries/claude-agent-acp`, display name to "Claude Agent"
- `src/shared/path-detector.ts` — Primary binary lookup is now `claude-agent-acp` with `claude-code-acp` fallback; added new paths alongside legacy ones in `COMMON_AGENT_PATHS`
- `src/components/OnboardingModal.ts` — Updated package to `@zed-industries/claude-agent-acp`, name to "Claude Agent"; changed `void this.saveSettings()` to `await this.saveSettings()` to fix race condition
- `src/components/settings/AgentClientSettingTab.ts` — Updated heading, placeholder, install hint, auto-detect tooltip, and notices to use `claude-agent-acp`
- `src/adapters/acp/acp.adapter.ts` — `getCommandNameForAgent()` returns `claude-agent-acp`; updated install command map
- `src/plugin.ts` — Default `displayName` changed to "Claude Agent"; added migration to update existing users' `displayName` from "Claude Code"

**What was kept (backwards compat):**
- Internal agent ID remains `"claude-code-acp"` — changing it would break existing users' `activeAgentId` and saved sessions
- Path detection tries `claude-agent-acp` first, falls back to `claude-code-acp` for users still on the old package
- `COMMON_AGENT_PATHS` includes both binary names on all platforms

---

### 10. Fixed: "Session Creation Failed" error during onboarding

After installing an agent via the onboarding wizard, the chat view (mounted behind the modal) would fire `createSession()` immediately on mount, before settings were saved. This produced a "Session Creation Failed" error visible once the modal closed.

**Files changed:**
- `src/components/chat/ChatView.tsx`

**Fix:**
- Guard the mount-time `useEffect` with `settings.hasCompletedOnboarding` — skip `createSession()` while onboarding is in progress
- When onboarding finishes and calls `saveSettingsAndNotify()` with `hasCompletedOnboarding: true`, the settings subscription updates the dependency, triggering `createSession()` with the correct agent command path
- No re-mount needed — the existing leaf reacts to the settings change

---

### 11. Onboarding UX improvements

Several improvements to the onboarding wizard for better first-time experience.

**Files changed:**
- `src/components/OnboardingModal.ts`
- `styles.css`

**Details:**
- **Path fallback fix**: When agent path auto-detection fails after install, the fallback now uses the actual binary name (`claude-agent-acp`) instead of the internal agent ID (`claude-code-acp`). Added `getAgentBinaryName()` method that maps agent IDs to platform-specific binary names.
- **Recommended highlight**: Claude Agent card now has an orange border (`#e08a2e`) via `.recommended` CSS class to draw attention as the recommended choice.
- **Platform-specific Node.js install hints**: Both error display paths (pre-rendered and inline) now show quick install commands:
  - Windows: `winget install OpenJS.NodeJS.LTS`
  - macOS: `brew install node`
  - Linux: `sudo apt install nodejs npm` (Debian/Ubuntu) or `sudo pacman -S nodejs npm` (Arch)
  - Plus fallback link to nodejs.org for all platforms
- **Dismissable error**: Installation Failed error block now has an "×" dismiss button so users can close it after installing Node.js externally, then retry with a clean UI.

---

### 12. Fixed: Windows path detection fails after npm install (requires restart)

After onboarding installed `claude-agent-acp` via npm, `where.exe claude-agent-acp.cmd` failed because Obsidian's process PATH didn't include the npm global bin directory (`%APPDATA%\npm`). The fallback common paths also failed because they used literal `%USERNAME%` which Node.js doesn't expand. Additionally, `pathExists()` was using `cmd.exe /c <path>` which tries to EXECUTE the file rather than check existence.

**Files changed:**
- `src/shared/path-detector.ts`

**Fix:**
- `COMMON_AGENT_PATHS` win32 now uses `process.env.APPDATA` + `path.join()` to build real resolved paths (e.g., `C:\Users\pauld\AppData\Roaming\npm\claude-agent-acp.cmd`)
- `pathExists()` now uses `fs.existsSync()` instead of the broken `cmd.exe /c` approach
- Added `fs.existsSync` and `path.join` imports
- After this fix, path detection works immediately after npm install without requiring an Obsidian restart

---

### 13. Fixed: Stale .cmd stubs fool "already installed" check when Node.js is uninstalled

On Windows, uninstalling Node.js does not remove the `.cmd` stubs in `%APPDATA%\npm\`. `existsSync()` finds `claude-agent-acp.cmd` and three separate code paths incorrectly trusted it:

1. **`installAgent()` early return** — skipped installation because the stub "existed"
2. **`installAgent()` close handler** — reported "Installation completed successfully!" even after npm said "'npm' is not recognized"
3. **`saveSettings()`** — saved the stale full path to settings, causing the chat view to try launching it (30-second timeout → "Session Creation Failed")

**Files changed:**
- `src/components/OnboardingModal.ts`

**Fix:**
- All three code paths now call `detectNodePath()` alongside `detectAgentPath()` — agent path is only trusted if Node.js is also available
- When Node.js is missing: install proceeds normally (shows "npm not recognized" error with platform-specific install hints), and `saveSettings()` saves the bare binary name instead of the stale full path

---

### Version bumps

- **v0.8.3** — Committed: ACP resource leaks and cleanup fixes
- **v0.8.4** — Entries 1–7 above (settings cleanup, auto-install removal, Linux fixes, Gemini error handling)
- **v0.8.5** — Entry 8 (onSessionUpdate vanishing responses fix)
- **v0.8.6** — Entries 9–12 (package rename migration, onboarding session creation fix, onboarding UX, Windows path detection fix)
- **v0.8.7** — Entry 13 (stale .cmd stub detection fix)
